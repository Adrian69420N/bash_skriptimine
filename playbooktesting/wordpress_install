#!/bin/bash

# Kontrollib, kas skript käivitatakse root-õigustega
if [ "$(id -u)" -ne 0 ]; then
  echo "Palun käivita see skript root kasutajana."
  exit 1
fi

# Logi funktsioon
logi() {
  echo "$(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# Kontrollige, kas vajalikud teenused on paigaldatud
kontrolli_teenus() {
  if ! dpkg -l | grep -q "$1"; then
    logi "$1 ei ole paigaldatud, paigaldatakse..."
    apt install -y "$1" || { echo "$1 paigaldamine ebaõnnestus!"; exit 1; }
  else
    logi "$1 on juba paigaldatud."
  fi
}

# Veenduge, et Apache, PHP ja MySQL on paigaldatud
kontrolli_teenus "apache2"
kontrolli_teenus "php"
kontrolli_teenus "mysql-server"

# Laadige alla ja paigaldage WordPress
logi "Laaditakse alla WordPressi..."
cd /var/www/html
wget https://wordpress.org/latest.tar.gz || { echo "WordPressi allalaadimine ebaõnnestus!"; exit 1; }
tar -xvzf latest.tar.gz || { echo "WordPressi failide pakkimine ebaõnnestus!"; exit 1; }
mv wordpress/* . || { echo "WordPressi failide liigutamine ebaõnnestus!"; exit 1; }
rm -rf wordpress latest.tar.gz

# Andmebaasi loomine WordPressile
DB_NAME="wordpress"
DB_USER="wordpressuser"
DB_PASS="wordpresspassword"
DB_HOST="localhost"

logi "Kontrollitakse, kas andmebaas $DB_NAME eksisteerib..."
mysql -u root -p"{{ mysql_root_password }}" -e "SHOW DATABASES LIKE '$DB_NAME';" | grep "$DB_NAME" || {
  logi "Andmebaas ei leitud, luuakse..."
  mysql -u root -p"{{ mysql_root_password }}" -e "CREATE DATABASE $DB_NAME;" || { echo "Andmebaasi loomine ebaõnnestus!"; exit 1; }
}

logi "Loo andmebaasi kasutaja ja andmebaasi õigused..."
mysql -u root -p"{{ mysql_root_password }}" -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'$DB_HOST' IDENTIFIED BY '$DB_PASS'; FLUSH PRIVILEGES;" || { echo "Andmebaasi kasutaja loomine ebaõnnestus!"; exit 1; }

# WordPressi konfigureerimine
logi "Kopeeritakse wp-config-sample.php wp-config.php... "
cp wp-config-sample.php wp-config.php

# Muuda wp-config.php, et seada andmebaasi ühendus
sed -i "s/database_name_here/$DB_NAME/" wp-config.php
sed -i "s/username_here/$DB_USER/" wp-config.php
sed -i "s/password_here/$DB_PASS/" wp-config.php
sed -i "s/localhost/$DB_HOST/" wp-config.php

# Seadistage Apache õigused WordPressi kaustas
logi "Seadistatakse õigused WordPressi kataloogis..."
chown -R www-data:www-data /var/www/html
chmod -R 755 /var/www/html

# Taaskäivita Apache teenus, et muudatused jõustuksid
logi "Käivitatakse Apache teenus..."
systemctl restart apache2 || { echo "Apache teenuse käivitamine ebaõnnestus!"; exit 1; }

logi "WordPressi paigaldus on lõpetatud ja teenused on käivitatud!"
