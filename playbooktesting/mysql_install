#!/bin/bash

# MySQL version and repository configuration
MYSQL_VERSION="9.1"
REPO_PACKAGE="mysql-apt-config_0.8.15-1_all.deb"
MYSQL_URL="https://dev.mysql.com/get/$REPO_PACKAGE"

# Check for root privileges
if [ "$EUID" -ne 0 ]; then
  echo "Please run as root"
  exit
fi

# Update the package list and install prerequisites
echo "Updating package list and installing prerequisites..."
sudo apt update
sudo apt install -y wget gnupg

# Download and install MySQL APT configuration package
echo "Downloading MySQL APT configuration package..."
wget $MYSQL_URL -O /tmp/$REPO_PACKAGE

echo "Installing MySQL APT configuration package..."
sudo dpkg -i /tmp/$REPO_PACKAGE

# Fix repository key issue if it occurs
echo "Updating package list..."
if ! sudo apt update; then
  echo "Fixing repository key issue..."
  sudo apt-key list
  sudo apt-key del A4A9 4068 76FC BD3C 4567 70C8 8C71 8D3B 5072 E1F5
  sudo apt-key adv --keyserver pgp.mit.edu --recv-keys 467B942D3A79BD29
  sudo apt update
fi

# Install MySQL server
echo "Installing MySQL Server $MYSQL_VERSION..."
sudo apt install -y mysql-server

# Confirm successful installation
if dpkg -l | grep -q mysql-server; then
  echo "MySQL Server $MYSQL_VERSION successfully installed."
else
  echo "MySQL installation failed."
  exit 1
fi

# Optional: set up a .my.cnf configuration file with a predefined password (for automation)
MYSQL_ROOT_PASSWORD="qwerty"
echo "Setting up .my.cnf file for MySQL root user..."
cat <<EOL > ~/.my.cnf
[client]
user=root
password=$MYSQL_ROOT_PASSWORD
EOL

echo "MySQL installation and configuration completed."
